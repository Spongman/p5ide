{"version":3,"sources":["auth.js"],"names":["__awaiter","this","thisArg","_arguments","P","generator","Promise","resolve","reject","fulfilled","value","step","next","e","rejected","result","done","then","apply","__generator","body","f","y","t","g","_","label","sent","trys","ops","verb","throw","return","Symbol","iterator","n","v","op","TypeError","call","pop","length","push","exports","__esModule","Auth","authenticated","prototype","initialize","token","_a","window","localStorage","access_token","authenticate","login","_b","fetchToken","userJson","fetch","method","headers","Authorization","cache","json","userName","document","classList","toggle","getElementById","textContent","logoff","remove","params","width","height","menubar","toolbar","personalbar","status","left","screenLeft","innerWidth","top","screenTop","innerHeight","loginWindow","open","Object","keys","map","k","join","addEventListener","onMessage","interval","setInterval","closed","close","clearInterval","removeEventListener","event","data","code","loginJson","text","URLSearchParams","get"],"mappings":"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","file":"auth.js","sourcesContent":["\"use strict\";\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nvar __generator = (this && this.__generator) || function (thisArg, body) {\n    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\n    return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\n    function verb(n) { return function (v) { return step([n, v]); }; }\n    function step(op) {\n        if (f) throw new TypeError(\"Generator is already executing.\");\n        while (_) try {\n            if (f = 1, y && (t = y[op[0] & 2 ? \"return\" : op[0] ? \"throw\" : \"next\"]) && !(t = t.call(y, op[1])).done) return t;\n            if (y = 0, t) op = [0, t.value];\n            switch (op[0]) {\n                case 0: case 1: t = op; break;\n                case 4: _.label++; return { value: op[1], done: false };\n                case 5: _.label++; y = op[1]; op = [0]; continue;\n                case 7: op = _.ops.pop(); _.trys.pop(); continue;\n                default:\n                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\n                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\n                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\n                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\n                    if (t[2]) _.ops.pop();\n                    _.trys.pop(); continue;\n            }\n            op = body.call(thisArg, _);\n        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\n        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\n    }\n};\nexports.__esModule = true;\nvar Auth = (function () {\n    function Auth() {\n        this.authenticated = false;\n    }\n    Auth.prototype.initialize = function () {\n        return __awaiter(this, void 0, void 0, function () {\n            var token;\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        token = window.localStorage.access_token;\n                        if (!token) return [3 /*break*/, 2];\n                        return [4 /*yield*/, this.authenticate(token)];\n                    case 1:\n                        if (!(_a.sent()))\n                            window.localStorage.access_token = null;\n                        _a.label = 2;\n                    case 2: return [2 /*return*/];\n                }\n            });\n        });\n    };\n    Auth.prototype.login = function () {\n        return __awaiter(this, void 0, void 0, function () {\n            var token, _a;\n            return __generator(this, function (_b) {\n                switch (_b.label) {\n                    case 0:\n                        if (this.authenticated)\n                            return [2 /*return*/];\n                        _a = window.localStorage;\n                        return [4 /*yield*/, this.fetchToken()];\n                    case 1:\n                        token = _a.access_token = _b.sent();\n                        if (!token) return [3 /*break*/, 3];\n                        return [4 /*yield*/, this.authenticate(token)];\n                    case 2:\n                        _b.sent();\n                        _b.label = 3;\n                    case 3: return [2 /*return*/];\n                }\n            });\n        });\n    };\n    Auth.prototype.authenticate = function (token) {\n        return __awaiter(this, void 0, void 0, function () {\n            var userResponse, userJson;\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0: return [4 /*yield*/, fetch(\"https://api.github.com/user\", {\n                            method: \"GET\",\n                            headers: {\n                                Authorization: \"token \" + token\n                            },\n                            cache: \"no-cache\"\n                        })];\n                    case 1:\n                        userResponse = _a.sent();\n                        return [4 /*yield*/, userResponse.json()];\n                    case 2:\n                        userJson = _a.sent();\n                        this.userName = userJson.login;\n                        this.authenticated = !!this.userName;\n                        document.body.classList.toggle(\"authenticated\", this.authenticated);\n                        document.getElementById(\"userName\").textContent = this.userName || \"\";\n                        return [2 /*return*/, this.authenticated];\n                }\n            });\n        });\n    };\n    Auth.prototype.logoff = function () {\n        delete window.localStorage.access_token;\n        delete this.userName;\n        this.authenticated = false;\n        document.body.classList.remove(\"authenticated\");\n    };\n    Auth.prototype.fetchToken = function () {\n        return new Promise(function (resolve, reject) {\n            var params = {\n                width: 450,\n                height: 600,\n                menubar: 0,\n                toolbar: 0,\n                personalbar: 0,\n                status: 0,\n                left: window.screenLeft + window.innerWidth - 450,\n                top: window.screenTop + window.innerHeight - 600\n            };\n            var loginWindow = window.open(\"https://github.com/login/oauth/authorize?scope=public_repo&client_id=2cb7dbbede12e09b2112\", \"_login\", Object.keys(params).map(function (k) { return k + '=' + params[k]; }).join(','));\n            window.addEventListener(\"message\", onMessage);\n            var interval = setInterval(function () {\n                if (!loginWindow || loginWindow.closed) {\n                    close();\n                    reject(\"cancelled\");\n                }\n            }, 250);\n            function close() {\n                clearInterval(interval);\n                window.removeEventListener(\"message\", onMessage);\n                loginWindow.close();\n            }\n            function onMessage(event) {\n                return __awaiter(this, void 0, void 0, function () {\n                    var data, code, loginResponse, loginJson, access_token;\n                    return __generator(this, function (_a) {\n                        switch (_a.label) {\n                            case 0:\n                                data = event.data;\n                                code = data && data.code;\n                                if (!code) return [3 /*break*/, 3];\n                                return [4 /*yield*/, fetch(\"https://p5ide.codewithoutborders.com/login?code=\" + code, {\n                                        cache: \"no-cache\"\n                                    })];\n                            case 1:\n                                loginResponse = _a.sent();\n                                return [4 /*yield*/, loginResponse.text()];\n                            case 2:\n                                loginJson = _a.sent();\n                                access_token = new URLSearchParams(loginJson).get(\"access_token\");\n                                close();\n                                if (access_token)\n                                    resolve(access_token);\n                                else\n                                    reject(\"failed\");\n                                _a.label = 3;\n                            case 3: return [2 /*return*/];\n                        }\n                    });\n                });\n            }\n        });\n    };\n    return Auth;\n}());\nexports.Auth = Auth;\n"]}